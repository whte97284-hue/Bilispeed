# 📺 B站数据分析与全能下载工具箱 (Ultimate Edition)

> 集成 **舆情分析**、**智能归档**、**流量监测** 及 **港澳台番剧(HMT)下载** 于一体的桌面端效率工具。
> 基于 Python、Streamlit、SQLite 与 BBDown 构建，专为创作与数据。

---

## 🚀 快速开始 (Quick Start)

为确保软件正常运行，请务必严格按照以下步骤操作：

1.  **解压文件**：🛑 **严禁在压缩包内直接运行**！请务必将压缩包解压至独立的文件夹。
2.  **环境自检**：确认文件夹内包含以下核心文件（首次运行会自动生成或调用）：
    * `Bili_Final.exe` (主程序)
    * `BBdown.exe` (下载引擎)
    * `ffmpeg.exe` (转码引擎)
    * `history/bili_data.db` (核心数据库，运行后生成)
3.  **启动程序**：双击 `Bili_Final.exe`。稍等片刻，系统将自动调用默认浏览器打开可视化控制台。

---

## 👤 账号与凭证管理 (Account & Token)

本工具采用 **SESSDATA** 与 **本地凭证 (BBDown.data)** 双轨制，确保最大的兼容性与稳定性。

### 方式一：扫码登录 (推荐 🔥)
1.  在侧边栏点击 **`📱 扫码登录 (BBDown)`** 按钮。
2.  等待控制台弹出二维码（或链接），使用 **手机 B 站 APP** 扫码。
3.  登录成功后，系统将自动提取凭证并同步至 Python 环境，侧边栏将显示您的头像与会员状态（如：`🟢 年度大会员`）。

### 方式二：手动填入 (备用)
若扫码失败，可手动获取 Cookie 中的 `SESSDATA` 字符串，粘贴至侧边栏的文本框中。

---

## 📦 六大核心模块 (Modules)

| 模块名称 | 功能亮点 |
| :--- | :--- |
| **📊 数据洞察** | 批量抓取 UP 主视频数据，存入 **SQLite 数据库**。表格支持**增量对比**（显示涨粉/涨播放趋势 🔺），支持一键跳转视频。 |
| **🎥 视频下载** | 集成 **BBDown**。支持普通/港澳台番剧下载，支持 **容量预估**、**进度条反馈**，自动调用 FFmpeg 合成 MP4。 |
| **🧠 舆情分析** | **(NEW)** 抓取视频评论区（支持**深度楼中楼**递归抓取），生成 **高清词云图**，绘制粉丝 **性别/等级/IP属地** 画像。 |
| **🗂️ 智能归档** | **(NEW)** 扫描下载目录，根据数据库元数据，一键将散乱文件按 `[UP主]/[年份]` 自动分类整理并重命名。 |
| **🔴 实时监控** | 对单个视频进行分钟级流量监控，内置 **哨兵机制**（自动检测并记录删评行为），数据可视化展示。 |
| **🖼️ 封面提取** | 一键扫描目标 UID 的所有投稿封面，支持在线预览、全选及批量下载高清原图。 |

---

## 🧠 舆情分析使用指南 (Sentiment Analysis)

> 这是一个强大的受众分析工具，能够透视评论区背后的真实声音。

1.  **选择视频**：既可以从“数据洞察”已抓取的库中选择，也可以手动输入任意 BVID。
2.  **抓取设置**：
    * **主楼页数**：控制抓取范围。
    * **深度抓取**：✅ **勾选后可展开折叠的“楼中楼”评论**（注意：开启后速度较慢且请求量大，请适度使用）。
3.  **分析报表**：
    * **☁️ 词云透视**：自动分词并过滤停用词，生成热词可视化图。
    * **👥 粉丝画像**：通过交互式饼图/柱状图展示评论者的性别比例、等级分布及 IP 属地排行。

---

## 🗂️ 智能归档使用指南 (Smart Archive)

> 告别杂乱的下载文件夹，让本地媒体库井井有条。

1.  **扫描**：进入模块，系统自动扫描 `history/videos` 根目录下的散乱视频文件。
2.  **匹配**：程序会自动根据文件名中的 BV 号，去数据库中反查该视频的 **UP主** 和 **发布年份**。
    * *提示：归档前建议先用【数据洞察】扫描一遍相关 UP 主，确保数据库里有元数据。*
3.  **执行**：点击“一键智能整理”，文件将被移动至 `_Archived/[UP主名字]/[年份]/` 目录下，并可自动重命名为 `[日期] 标题.mp4` 格式。

---

## 🌏 港澳台番剧下载指南 (HMT Download)

> **策略**：采用“Web 接口 + 本地凭证”的组合拳，最大程度绕过区域限制。

### 1. 前置条件
* ✅ **账号**：必须是 **Bilibili 大会员**（年度/季度/月度）。
* ✅ **网络**：必须拥有高质量的 **台湾或香港原生 IP 代理节点**。

### 2. 推荐配置 (必看)
进入 `视频下载` -> `直链/番剧下载`：
* **资源链接**：输入 `ssID` 或 `epID`。
* **HTTP 代理**：**必填** (如 `127.0.0.1:7890`)。
* **接口模式**：务必选择 **`Web 接口 (推荐)`**。
    * *原因：APP 接口对 IP 纯净度要求极高，Web 接口兼容性最好。*
* **画质/编码**：建议设为 **`自动 (Auto)`**。
* **Aria2 加速**：**❌ 必须关闭**。
    * *原因：多线程极易触发 SSL 阻断 (net_http_ssl_connection_failed)，单线程最稳。*
* **使用扫码凭证**：**✅ 勾选**。

---

## 🛠️ 常见问题排查 (FAQ)

<details>
<summary><strong>Q1: 舆情分析显示“未抓取到数据”或报错参数错误？</strong></summary>

* **原因**：B 站 API 更新频繁，或者视频评论区已关闭/需登录。
* **解法**：最新版 V48 已加入 **“参数自动嗅探”** 和 **“自愈合”** 机制，重启程序通常可解决。如果依然失败，请检查是否被风控（日志显示 412 错误）。
</details>

<details>
<summary><strong>Q2: 港澳台下载报错 `Arg_IndexOutOfRangeException`？</strong></summary>

* **原因**：获取到的流列表为空。通常是 IP 被判定非港澳台，或账号无会员。
* **解法**：
    1. 检查侧边栏账号状态是否为“大会员”。
    2. 切换为 **Web 接口**。
    3. 更换代理节点。
</details>

<details>
<summary><strong>Q3: 归档时文件被移动到了“未分类”文件夹？</strong></summary>

* **原因**：数据库中没有该视频的元数据（UP主、发布时间等）。
* **解法**：先复制该视频的 UID 或 BV 号，去 **【数据洞察】** 模块执行一次分析，元数据入库后，再执行归档即可自动识别。
</details>

<details>
<summary><strong>Q4: 界面报错 `NotFoundError: ... removeChild`？</strong></summary>

* **原因**：后台日志刷新频率过高（如下载进度条），导致前端渲染引擎崩溃。
* **解法**：此错误不影响后台任务。最新版已加入日志限速逻辑，**重启终端/程序**即可恢复。
</details>

---

## 📝 版本历史

* **V50.x (Ultimate)**：引入智能凭证托管中心，侧边栏可视化显示会员状态；修复 API 调用兼容性。
* **V48.x (Analysis)**：重构舆情分析模块，支持参数暴力嗅探与自愈合，解决评论抓取失败问题。
* **V41.x (Archive)**：新增智能归档模块；引入 SQLite 数据库替代 CSV，实现数据联通。
* **V37.0 (HMT Stable)**：确立“Web接口+单线程”的港澳台救砖策略。
